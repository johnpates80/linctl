#!/usr/bin/env python3
"""
BMAD Portfolio Management CLI

Manage multiple BMAD projects from a centralized portfolio configuration.

Usage:
  bmad-portfolio init
  bmad-portfolio list [--enabled-only] [--json]
  bmad-portfolio add PROJECT_PATH [--name NAME] [--auto-sync] [--no-comments]
  bmad-portfolio remove PROJECT_KEY
  bmad-portfolio discover [--save] [--json]
  bmad-portfolio settings PROJECT_KEY [--set KEY=VALUE ...]
  bmad-portfolio info [PROJECT_KEY]
  bmad-portfolio sync [--dry-run] [--workers N] [--detailed] [--projects KEY ...]
"""

import argparse
import json
import sys
from pathlib import Path
from typing import Dict, Any

sys.path.insert(0, str(Path(__file__).resolve().parents[1] / 'lib'))

from portfolio_config import (
    PortfolioConfig,
    PortfolioConfigError,
    load_portfolio_config
)
from bulk_sync import BulkSyncEngine, format_bulk_result


def cmd_init(args: argparse.Namespace) -> int:
    """Initialize portfolio configuration."""
    try:
        config = PortfolioConfig()
        config.save()
        print(f"✓ Portfolio initialized: {config.config_path}")
        print(f"  Run 'bmad-portfolio discover --save' to auto-discover projects")
        return 0
    except PortfolioConfigError as e:
        print(f"✗ Failed to initialize portfolio:\n{e}", file=sys.stderr)
        return 1


def cmd_list(args: argparse.Namespace) -> int:
    """List registered projects."""
    try:
        config = load_portfolio_config()
        projects = config.list_projects(enabled_only=args.enabled_only)

        if args.json:
            print(json.dumps(projects, indent=2))
            return 0

        if not projects:
            print("No projects registered in portfolio")
            print("  Run 'bmad-portfolio discover --save' to auto-discover")
            print("  Or 'bmad-portfolio add <path>' to manually register")
            return 0

        print(f"Portfolio Projects ({len(projects)}):\n")
        for project in projects:
            status = "✓" if project.get('enabled', True) else "✗"
            print(f"{status} {project['key']}")
            print(f"  Name: {project['name']}")
            print(f"  Path: {project['path']}")
            if 'settings' in project:
                print(f"  Custom Settings: {len(project['settings'])} override(s)")
            print()

        return 0
    except PortfolioConfigError as e:
        print(f"✗ Error listing projects:\n{e}", file=sys.stderr)
        return 1


def cmd_add(args: argparse.Namespace) -> int:
    """Register a project in the portfolio."""
    try:
        config = load_portfolio_config()

        # Build custom settings if provided
        settings = {}
        if args.auto_sync is not None:
            settings['auto_sync'] = args.auto_sync
        if args.no_comments:
            settings['preserve_linear_comments'] = False

        project_key = config.register_project(
            Path(args.project_path),
            project_name=args.name,
            settings=settings if settings else None
        )
        config.save()

        print(f"✓ Project registered: {project_key}")
        print(f"  Path: {args.project_path}")
        if settings:
            print(f"  Settings: {settings}")

        return 0
    except PortfolioConfigError as e:
        print(f"✗ Failed to register project:\n{e}", file=sys.stderr)
        return 1


def cmd_remove(args: argparse.Namespace) -> int:
    """Unregister a project from the portfolio."""
    try:
        config = load_portfolio_config()
        config.unregister_project(args.project_key)
        config.save()

        print(f"✓ Project unregistered: {args.project_key}")
        return 0
    except PortfolioConfigError as e:
        print(f"✗ Failed to unregister project:\n{e}", file=sys.stderr)
        return 1


def cmd_discover(args: argparse.Namespace) -> int:
    """Discover BMAD projects in configured search paths."""
    try:
        config = load_portfolio_config()
        discovered = config.discover_projects(save=args.save)

        if args.json:
            print(json.dumps(discovered, indent=2))
            return 0

        if not discovered:
            print("No new projects discovered")
            print(f"  Search paths: {config.get('discovery.search_paths')}")
            return 0

        print(f"Discovered Projects ({len(discovered)}):\n")
        for project in discovered:
            print(f"• {project['name']}")
            print(f"  Path: {project['path']}")
            print(f"  Config: {project['config_file']}")
            print()

        if args.save:
            config.save()
            print(f"✓ Registered {len(discovered)} project(s)")
        else:
            print("Run with '--save' to register these projects")

        return 0
    except PortfolioConfigError as e:
        print(f"✗ Discovery failed:\n{e}", file=sys.stderr)
        return 1


def cmd_settings(args: argparse.Namespace) -> int:
    """View or update project settings."""
    try:
        config = load_portfolio_config()

        # Show current settings if no updates provided
        if not args.set:
            settings = config.get_project_settings(args.project_key)
            print(f"Settings for {args.project_key}:")
            print(json.dumps(settings, indent=2))
            return 0

        # Parse and apply settings updates
        updates = {}
        for setting in args.set:
            if '=' not in setting:
                print(f"✗ Invalid setting format: {setting}", file=sys.stderr)
                print("  Use: KEY=VALUE", file=sys.stderr)
                return 1

            key, value = setting.split('=', 1)

            # Parse boolean values
            if value.lower() in ('true', 'false'):
                value = value.lower() == 'true'
            # Parse null
            elif value.lower() == 'null':
                value = None

            updates[key] = value

        config.update_project_settings(args.project_key, updates)
        config.save()

        print(f"✓ Updated settings for {args.project_key}:")
        for key, value in updates.items():
            print(f"  {key} = {value}")

        return 0
    except PortfolioConfigError as e:
        print(f"✗ Settings operation failed:\n{e}", file=sys.stderr)
        return 1


def cmd_sync(args: argparse.Namespace) -> int:
    """Execute bulk sync across portfolio projects."""
    try:
        config = load_portfolio_config()

        # Initialize bulk sync engine
        engine = BulkSyncEngine(
            portfolio_config=config,
            max_workers=args.workers,
            dry_run=args.dry_run
        )

        # Progress callback for live updates
        def progress_callback(progress):
            if not args.json:
                print(
                    f"\rProgress: {progress['completed']}/{progress['total']} "
                    f"({progress['percent']}%) - In progress: {progress['in_progress']}",
                    end='', flush=True
                )

        # Execute sync (all projects or selective)
        if args.projects:
            result = engine.sync_selective(args.projects, progress_callback=progress_callback)
        else:
            result = engine.sync_all(progress_callback=progress_callback)

        # Clear progress line
        if not args.json:
            print()  # New line after progress

        # Output results
        if args.json:
            # JSON output for programmatic use
            output = {
                'timestamp': result.timestamp,
                'summary': {
                    'total_projects': result.total_projects,
                    'successful': result.successful_projects,
                    'failed': result.failed_projects,
                    'operations_applied': result.total_applied,
                    'operations_failed': result.total_failed,
                    'conflicts': result.total_conflicts,
                    'duration': result.duration_seconds
                },
                'projects': [
                    {
                        'key': pr.project_key,
                        'name': pr.project_name,
                        'success': pr.success,
                        'operations': {
                            'planned': pr.operations_planned,
                            'applied': pr.operations_applied,
                            'failed': pr.operations_failed
                        },
                        'conflicts': pr.conflicts,
                        'duration': pr.duration_seconds,
                        'error': pr.error_message
                    }
                    for pr in result.project_results
                ]
            }
            print(json.dumps(output, indent=2))
        else:
            # Human-readable output
            print(format_bulk_result(result, detailed=args.detailed))

        return 0 if result.failed_projects == 0 else 1

    except PortfolioConfigError as e:
        print(f"✗ Bulk sync failed:\n{e}", file=sys.stderr)
        return 1
    except Exception as e:
        print(f"✗ Unexpected error during bulk sync:\n{e}", file=sys.stderr)
        return 1


def cmd_info(args: argparse.Namespace) -> int:
    """Show portfolio or project information."""
    try:
        config = load_portfolio_config()

        # Portfolio-level info if no project specified
        if not args.project_key:
            info = {
                'portfolio': config.config.get('portfolio'),
                'defaults': config.config.get('defaults'),
                'project_count': len(config.list_projects()),
                'enabled_count': len(config.list_projects(enabled_only=True)),
                'discovery': config.config.get('discovery')
            }
            print(json.dumps(info, indent=2))
            return 0

        # Project-specific info
        project = config.get_project(args.project_key)
        effective_settings = config.get_project_settings(args.project_key)

        info = {
            'key': args.project_key,
            'project': project,
            'effective_settings': effective_settings
        }
        print(json.dumps(info, indent=2))
        return 0
    except PortfolioConfigError as e:
        print(f"✗ Info retrieval failed:\n{e}", file=sys.stderr)
        return 1


def main() -> int:
    parser = argparse.ArgumentParser(
        prog='bmad-portfolio',
        description='Manage multiple BMAD projects from a centralized portfolio'
    )
    subparsers = parser.add_subparsers(dest='command', required=True)

    # init command
    subparsers.add_parser('init', help='Initialize portfolio configuration')

    # list command
    list_parser = subparsers.add_parser('list', help='List registered projects')
    list_parser.add_argument('--enabled-only', action='store_true',
                            help='Only show enabled projects')
    list_parser.add_argument('--json', action='store_true',
                            help='Output as JSON')

    # add command
    add_parser = subparsers.add_parser('add', help='Register a project')
    add_parser.add_argument('project_path', help='Path to BMAD project root')
    add_parser.add_argument('--name', help='Custom project name')
    add_parser.add_argument('--auto-sync', type=bool, help='Enable auto-sync')
    add_parser.add_argument('--no-comments', action='store_true',
                           help='Disable Linear comment preservation')

    # remove command
    remove_parser = subparsers.add_parser('remove', help='Unregister a project')
    remove_parser.add_argument('project_key', help='Project identifier')

    # discover command
    discover_parser = subparsers.add_parser('discover',
                                           help='Auto-discover BMAD projects')
    discover_parser.add_argument('--save', action='store_true',
                                help='Auto-register discovered projects')
    discover_parser.add_argument('--json', action='store_true',
                                help='Output as JSON')

    # settings command
    settings_parser = subparsers.add_parser('settings',
                                           help='View or update project settings')
    settings_parser.add_argument('project_key', help='Project identifier')
    settings_parser.add_argument('--set', nargs='+',
                                help='Settings to update (KEY=VALUE format)')

    # sync command
    sync_parser = subparsers.add_parser('sync',
                                       help='Execute bulk sync across portfolio')
    sync_parser.add_argument('--dry-run', action='store_true',
                            help='Plan only (no changes applied)')
    sync_parser.add_argument('--workers', type=int, default=4,
                            help='Maximum parallel workers (default: 4)')
    sync_parser.add_argument('--detailed', action='store_true',
                            help='Show detailed per-project results')
    sync_parser.add_argument('--json', action='store_true',
                            help='Output as JSON')
    sync_parser.add_argument('--projects', nargs='+',
                            help='Specific project keys to sync')

    # info command
    info_parser = subparsers.add_parser('info',
                                       help='Show portfolio or project information')
    info_parser.add_argument('project_key', nargs='?',
                            help='Project identifier (optional)')

    args = parser.parse_args()

    # Dispatch to command handlers
    if args.command == 'init':
        return cmd_init(args)
    elif args.command == 'list':
        return cmd_list(args)
    elif args.command == 'add':
        return cmd_add(args)
    elif args.command == 'remove':
        return cmd_remove(args)
    elif args.command == 'discover':
        return cmd_discover(args)
    elif args.command == 'settings':
        return cmd_settings(args)
    elif args.command == 'sync':
        return cmd_sync(args)
    elif args.command == 'info':
        return cmd_info(args)

    return 1


if __name__ == '__main__':
    sys.exit(main())
